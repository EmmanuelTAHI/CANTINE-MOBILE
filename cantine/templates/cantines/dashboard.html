{% extends "cantines/base.html" %}
{% load static %}

{% block title %}Dashboard - Gestion Cantine HEG{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="relative bg-gradient-to-r from-heg-violet/10 via-white to-heg-violet/10 py-16 mb-12">
    <div class="container mx-auto px-4">
        <div class="text-center">
            <h1 class="text-6xl font-heading font-bold mb-4 text-heg-gris">
                Cantine
            </h1>
            <p class="text-xl text-heg-gris/70 max-w-2xl mx-auto">
                Gestion professionnelle de la restauration scolaire
            </p>
        </div>
    </div>
</div>

<!-- Alertes -->
{% if alertes %}
<div class="container mx-auto px-4 mb-6">
    {% for alerte in alertes %}
    <div class="alert alert-{{ alerte.type }} shadow-lg mb-3">
        <i class="fas fa-{% if alerte.type == 'warning' %}exclamation-triangle{% elif alerte.type == 'info' %}info-circle{% else %}check-circle{% endif %}"></i>
        <span>{{ alerte.message }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Stats Cards -->
<div class="container mx-auto px-4 mb-12">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-users text-primary text-xl"></i>
                </div>
            </div>
            <h3 class="text-sm text-neutral/70 mb-1">Élèves inscrits</h3>
            <p class="text-3xl font-bold text-neutral">{{ stats.total_eleves }}</p>
            <p class="text-xs text-neutral/50 mt-2">Dont {{ stats.eleves_actifs }} actifs</p>
        </div>

        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-success/10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-success text-xl"></i>
                </div>
            </div>
            <h3 class="text-sm text-neutral/70 mb-1">Repas aujourd'hui</h3>
            <p class="text-3xl font-bold text-neutral">{{ stats.repas_aujourd_hui }}</p>
            <p class="text-xs text-neutral/50 mt-2">Repas servis</p>
        </div>

        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-info/10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-calendar-check text-info text-xl"></i>
                </div>
            </div>
            <h3 class="text-sm text-neutral/70 mb-1">Repas ce mois</h3>
            <p class="text-3xl font-bold text-neutral">{{ stats.repas_ce_mois }}</p>
            <p class="text-xs text-neutral/50 mt-2">Total repas servis</p>
        </div>

        {% if is_admin %}
        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-warning/10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-file-invoice text-warning text-xl"></i>
                </div>
            </div>
            <h3 class="text-sm text-neutral/70 mb-1">Abonnements en retard</h3>
            <p class="text-3xl font-bold text-neutral">{{ stats.factures_en_attente }}</p>
            <p class="text-xs text-neutral/50 mt-2">Solde négatif détecté</p>
        </div>
        {% else %}
        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-warning/10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-calendar-alt text-warning text-xl"></i>
                </div>
            </div>
            <h3 class="text-sm text-neutral/70 mb-1">Élèves inscrits ce mois</h3>
            <p class="text-3xl font-bold text-neutral">{{ stats.eleves_inscrits_mois|default:0 }}</p>
            <p class="text-xs text-neutral/50 mt-2">Inscriptions actives</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Menu du jour -->
{% if menu_du_jour %}
<div class="container mx-auto px-4 mb-12">
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
        <div class="flex flex-col md:flex-row">
            <div class="md:w-1/3">
                {% if menu_du_jour.photo %}
                <img src="{{ menu_du_jour.photo.url }}" alt="{{ menu_du_jour.plat_principal }}" class="w-full h-full object-cover min-h-[300px]">
                {% else %}
                <div class="w-full h-full bg-gradient-to-br from-primary/20 to-secondary/20 min-h-[300px] flex items-center justify-center">
                    <i class="fas fa-utensils text-8xl text-primary/30"></i>
                </div>
                {% endif %}
            </div>
            <div class="md:w-2/3 p-8">
                <h2 class="text-3xl font-heading font-bold mb-6 text-neutral">
                    Menu du jour
                </h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <p class="text-sm text-neutral/70 mb-1">Plat principal</p>
                        <p class="text-lg font-semibold text-neutral">{{ menu_du_jour.plat_principal }}</p>
                    </div>
                    {% if menu_du_jour.accompagnement %}
                    <div>
                        <p class="text-sm text-neutral/70 mb-1">Accompagnement</p>
                        <p class="text-lg font-semibold text-neutral">{{ menu_du_jour.accompagnement }}</p>
                    </div>
                    {% endif %}
                    {% if menu_du_jour.dessert %}
                    <div>
                        <p class="text-sm text-neutral/70 mb-1">Dessert</p>
                        <p class="text-lg font-semibold text-neutral">{{ menu_du_jour.dessert }}</p>
                    </div>
                    {% endif %}
                </div>
                <div class="flex items-center justify-end pt-4 border-t border-gray-200">
                    <a href="{% url 'cantine:menu_list' %}" class="text-primary hover:underline font-semibold">VOIR LES MENUS →</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Actions rapides -->
<div class="container mx-auto px-4 mb-12">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <a href="{% url 'cantine:decompte_journalier' %}" class="bg-primary text-white rounded-lg p-6 hover:bg-secondary transition-colors shadow-sm hover:shadow-md text-center">
            <i class="fas fa-check-circle text-3xl mb-3"></i>
            <p class="font-semibold">Décompte du jour</p>
        </a>
        {% if is_admin %}
        <a href="{% url 'cantine:eleve_create' %}" class="bg-info text-white rounded-lg p-6 hover:bg-info/90 transition-colors shadow-sm hover:shadow-md text-center">
            <i class="fas fa-user-plus text-3xl mb-3"></i>
            <p class="font-semibold">Ajouter un élève</p>
        </a>
        <a href="{% url 'cantine:eleve_import' %}" class="bg-success text-white rounded-lg p-6 hover:bg-success/90 transition-colors shadow-sm hover:shadow-md text-center">
            <i class="fas fa-file-upload text-3xl mb-3"></i>
            <p class="font-semibold">Importer des élèves</p>
        </a>
        {% endif %}
        {% if not is_admin %}
        <a href="{% url 'cantine:menu_create' %}" class="bg-warning text-white rounded-lg p-6 hover:bg-warning/90 transition-colors shadow-sm hover:shadow-md text-center">
            <i class="fas fa-plus-circle text-3xl mb-3"></i>
            <p class="font-semibold">Créer un menu</p>
        </a>
        {% endif %}
    </div>
</div>

<!-- Dernières activités -->
<div class="container mx-auto px-4 mb-12">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Repas récents -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <h2 class="text-2xl font-heading font-bold mb-6 text-neutral">
                <i class="fas fa-history text-primary mr-2"></i>Repas récents
            </h2>
            <div class="space-y-4">
                {% for repas in repas_recents %}
                <div class="flex items-center gap-4 pb-4 border-b border-gray-100 last:border-0">
                    {% if repas.eleve.photo %}
                    <div class="avatar">
                        <div class="w-12 rounded-full ring-2 ring-primary/20">
                            <img src="{{ repas.eleve.photo.url }}" alt="{{ repas.eleve }}">
                        </div>
                    </div>
                    {% else %}
                    <div class="avatar placeholder">
                        <div class="bg-primary/10 text-primary rounded-full w-12 ring-2 ring-primary/20">
                            <span class="text-sm font-semibold">{{ repas.eleve.prenom|first }}{{ repas.eleve.nom|first }}</span>
                        </div>
                    </div>
                    {% endif %}
                    <div class="flex-grow">
                        <p class="font-semibold text-neutral">{{ repas.eleve.prenom }} {{ repas.eleve.nom }}</p>
                        <p class="text-sm text-neutral/60">{{ repas.date|date:"d/m/Y" }}</p>
                        {% if repas.menu %}
                        <p class="text-xs text-neutral/50">{{ repas.menu.plat_principal }}</p>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-center text-neutral/60 py-8">Aucun repas récent</p>
                {% endfor %}
            </div>
            <div class="mt-6 text-center">
                <a href="{% url 'cantine:detail_plats_servis' %}" class="text-primary hover:underline font-semibold">Voir tout →</a>
            </div>
        </div>

        <!-- Statistiques rapides -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <h2 class="text-2xl font-heading font-bold mb-6 text-neutral">
                <i class="fas fa-chart-bar text-info mr-2"></i>Statistiques rapides
            </h2>
            <div class="space-y-4">
                <div class="flex items-center justify-between pb-4 border-b border-gray-100">
                    <div>
                        <p class="font-semibold text-neutral">Repas aujourd'hui</p>
                        <p class="text-sm text-neutral/60">Total des repas servis</p>
                    </div>
                    <p class="font-bold text-primary text-xl">{{ stats.repas_aujourd_hui }}</p>
                </div>
                <div class="flex items-center justify-between pb-4 border-b border-gray-100">
                    <div>
                        <p class="font-semibold text-neutral">Repas ce mois</p>
                        <p class="text-sm text-neutral/60">Total du mois en cours</p>
                    </div>
                    <p class="font-bold text-info text-xl">{{ stats.repas_ce_mois }}</p>
                </div>
                {% if is_admin %}
                <div class="flex items-center justify-between pb-4 border-b border-gray-100">
                    <div>
                        <p class="font-semibold text-neutral">Abonnements à surveiller</p>
                        <p class="text-sm text-neutral/60">Solde négatif</p>
                    </div>
                    <p class="font-bold text-warning text-xl">{{ stats.factures_en_attente }}</p>
                </div>
                {% endif %}
            </div>
            <div class="mt-6 text-center">
                <a href="{% url 'cantine:decompte_mensuel' %}" class="text-primary hover:underline font-semibold">Voir les décomptes →</a>
            </div>
        </div>
    </div>
</div>

<!-- Graphique repas (si données disponibles) -->
{% if repas_par_jour_data %}
<div class="container mx-auto px-4 mb-12">
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-heading font-bold mb-6 text-neutral">
            <i class="fas fa-chart-line text-primary mr-2"></i>Repas servis (30 derniers jours)
        </h2>
        <div class="relative h-64">
            <canvas id="repasChart"></canvas>
        </div>
    </div>
</div>
{% endif %}

{% block extra_scripts %}
{% if repas_par_jour_data %}
<script>
	document.addEventListener('DOMContentLoaded', function() {
	    const ctx = document.getElementById('repasChart');
	    if (ctx) {
	        const data = JSON.parse('{{ repas_par_jour_data|escapejs }}');
	        const labels = data.map(d => d.date);
	        const counts = data.map(d => d.count);

	        new Chart(ctx, {
	            type: 'line',
	            data: {
	                labels: labels,
	                datasets: [{
	                    label: 'Nombre de repas',
	                    data: counts,
	                    borderColor: 'rgb(59, 130, 246)',
	                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
	                    tension: 0.4,
	                    fill: true
	                }]
	            },
	            options: {
	                responsive: true,
	                maintainAspectRatio: false,
	                plugins: {
	                    legend: {
	                        display: false
	                    }
	                },
	                scales: {
	                    y: {
	                        beginAtZero: true,
	                        ticks: {
	                            stepSize: 1
	                        }
	                    }
	                }
	            }
	        });
	    }
	});
</script>
{% endif %}
{% endblock %}
{% endblock %}
