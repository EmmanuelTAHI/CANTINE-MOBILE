{% extends "cantines/base.html" %}

{% block title %}Connexion · Gestion Cantine HEG{% endblock %}

{% block extra_head %}
{{ block.super }}
<style>
    .login-feedback {
        display: flex;
        align-items: center;
        gap: 0.85rem;
        padding: 0.85rem 1rem;
        margin-top: 1rem;
        border-radius: 1.25rem;
        background: #fff;
        border: 1px solid rgba(144, 44, 142, 0.1);
        box-shadow: 0 10px 35px rgba(18, 16, 37, 0.08);
        transition: opacity 0.25s ease, transform 0.25s ease, border-color 0.25s ease;
        opacity: 0;
        transform: translateY(8px);
        pointer-events: none;
    }

    .login-feedback[data-state="loading"],
    .login-feedback[data-state="success"],
    .login-feedback[data-state="error"] {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }

    .login-feedback[data-state="success"] {
        border-color: rgba(52, 199, 89, 0.35);
        box-shadow: 0 15px 40px rgba(52, 199, 89, 0.18);
    }

    .login-feedback[data-state="error"] {
        border-color: rgba(236, 72, 72, 0.35);
        box-shadow: 0 15px 40px rgba(236, 72, 72, 0.18);
    }

    .status-icon {
        width: 44px;
        height: 44px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(144, 44, 142, 0.08);
        color: #902c8e;
        font-weight: 600;
        font-size: 1rem;
        position: relative;
    }

    .status-indicator {
        display: none;
        align-items: center;
        justify-content: center;
    }

    .login-feedback[data-state="loading"] .status-icon {
        background: rgba(144, 44, 142, 0.12);
    }

    .login-feedback[data-state="success"] .status-icon {
        background: rgba(52, 199, 89, 0.15);
        color: #1b9a4c;
    }

    .login-feedback[data-state="error"] .status-icon {
        background: rgba(236, 72, 72, 0.15);
        color: #be123c;
    }

    .login-feedback[data-state="loading"] .status-indicator[data-type="loading"],
    .login-feedback[data-state="success"] .status-indicator[data-type="success"],
    .login-feedback[data-state="error"] .status-indicator[data-type="error"] {
        display: inline-flex;
    }

    .spinner {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 2px solid currentColor;
        border-top-color: transparent;
        animation: spin 0.85s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .login-form button[disabled] {
        opacity: 0.75;
        cursor: not-allowed;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<section class="container flex min-h-[70vh] items-center justify-center py-12">
    <div class="grid w-full max-w-5xl gap-8 rounded-3xl bg-white p-10 shadow-2xl md:grid-cols-2">
        <div class="flex flex-col justify-between">
            <div>
                <span class="inline-flex items-center rounded-full bg-heg-violet/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-heg-violet">Espace sécurisé</span>
                <h2 class="mt-4 text-3xl font-semibold text-heg-violet">Bienvenue sur la plateforme cantine</h2>
                <p class="mt-3 text-sm leading-relaxed text-heg-gris/80">
                    Connectez-vous en tant qu'administrateur pour gérer les inscriptions, la facturation et les statistiques.
                    Les prestataires accèdent ici à la liste des élèves, au pointage et à la planification des menus avec visuels.
                </p>
            </div>
            <div class="hidden md:block">
                <div class="rounded-2xl bg-gradient-to-br from-heg-violet to-heg-violetDark p-6 text-white shadow-lg">
                    <p class="text-lg font-semibold">Nouveautés</p>
                    <ul class="mt-4 space-y-2 text-sm text-white/80">
                        <li>• Tableaux de bord détaillés avec indicateurs clairs</li>
                        <li>• Gestion des menus journaliers et mensuels avec photos</li>
                        <li>• Exports rapides et rapports synthétiques</li>
                        <li>• Profil utilisateur enrichi avec photo et coordonnées</li>
                    </ul>
                </div>
            </div>
        </div>
        <div>
            <div class="rounded-2xl border border-heg-gris/10 bg-heg-grisClair/60 p-8 shadow-inner">
                <h3 class="text-xl font-semibold text-heg-gris">Connexion</h3>
                <p class="mt-1 text-sm text-heg-gris/70">Veuillez saisir vos identifiants pour accéder à votre interface.</p>
                <form method="post" id="login-form" data-default-redirect="{% url 'cantine:dashboard_redirect' %}" class="login-form mt-6 space-y-5" novalidate>
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                        <div class="rounded-xl border border-heg-violet/40 bg-heg-violet/10 p-3 text-sm text-heg-violet" data-general-error>
                            {% for error in form.non_field_errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="hidden" data-general-error></div>
                    {% endif %}
                    <div class="form-control">
                        <label class="label text-sm font-medium text-heg-gris" for="{{ form.username.id_for_label }}">Identifiant</label>
                        {{ form.username }}
                        <p class="mt-1 text-xs text-heg-violet {% if not form.username.errors %}hidden{% endif %}" data-field-error="username">
                            {% if form.username.errors %}{{ form.username.errors.0 }}{% endif %}
                        </p>
                    </div>
                    <div class="form-control">
                        <label class="label text-sm font-medium text-heg-gris" for="{{ form.password.id_for_label }}">Mot de passe</label>
                        {{ form.password }}
                        <p class="mt-1 text-xs text-heg-violet {% if not form.password.errors %}hidden{% endif %}" data-field-error="password">
                            {% if form.password.errors %}{{ form.password.errors.0 }}{% endif %}
                        </p>
                    </div>
                    <div class="flex items-center justify-end text-sm text-heg-gris/70">
                        <a href="#" class="text-heg-violet hover:text-heg-violetDark">Besoin d'aide ?</a>
                    </div>
                    <button type="submit" class="btn w-full bg-heg-violet text-white hover:bg-heg-violetDark">Se connecter</button>
                </form>
                <div id="login-feedback" class="login-feedback" data-state="{% if form.errors %}error{% else %}idle{% endif %}" data-idle-message="Vos identifiants restent confidentiels.">
                    <span class="status-icon" aria-hidden="true">
                        <span class="status-indicator" data-type="loading"><span class="spinner"></span></span>
                        <span class="status-indicator" data-type="success">Yes</span>
                        <span class="status-indicator" data-type="error">&times;</span>
                    </span>
                    <div class="text-sm text-heg-gris/80" data-feedback-message>
                        {% if form.errors %}
                            Identifiants incorrects. Merci de réessayer.
                        {% else %}
                            Vos identifiants restent confidentiels.
                        {% endif %}
                    </div>
                </div>
            </div>
            <p class="mt-6 text-center text-xs text-heg-gris/60">
                Accès réservé au personnel autorisé. Contactez l'administration HEG pour activer votre compte prestataire.
            </p>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector("#login-form");
        if (!form) {
            return;
        }

        const submitButton = form.querySelector('button[type="submit"]');
        const feedback = document.getElementById("login-feedback");
        const messageTarget = feedback?.querySelector("[data-feedback-message]");
        const defaultMessage = feedback?.dataset.idleMessage || "";

        const setFeedbackState = (state, message) => {
            if (!feedback) {
                return;
            }
            feedback.dataset.state = state;
            if (messageTarget) {
                messageTarget.textContent = message || defaultMessage;
            }
        };

        const clearFieldErrors = () => {
            form.querySelectorAll("[data-field-error]").forEach((element) => {
                element.textContent = "";
                element.classList.add("hidden");
            });
        };

        const applyFieldErrors = (errors) => {
            if (!errors) {
                return;
            }
            Object.entries(errors).forEach(([field, messages]) => {
                if (!messages || !messages.length) {
                    return;
                }
                if (field === "__all__") {
                    setFeedbackState("error", messages[0]);
                    return;
                }
                const target = form.querySelector(`[data-field-error="${field}"]`);
                if (target) {
                    target.textContent = messages[0];
                    target.classList.remove("hidden");
                }
            });
        };

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            if (form.dataset.submitting === "true") {
                return;
            }
            form.dataset.submitting = "true";
            clearFieldErrors();
            submitButton?.setAttribute("disabled", "disabled");
            setFeedbackState("loading", "Vérification des identifiants...");

            let isSuccess = false;

            try {
                const formData = new FormData(form);
                const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
                const response = await fetch(form.action, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": csrfInput?.value || "",
                    },
                    body: formData,
                });

                let data = null;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    data = null;
                }

                if (response.ok && data?.status === "success") {
                    isSuccess = true;
                    setFeedbackState("success", "Yes ! Accès confirmé, redirection en cours…");
                    setTimeout(() => {
                        window.location.href = data.redirect_url || form.dataset.defaultRedirect || "/";
                    }, 650);
                    return;
                }

                const message =
                    data?.message || "Identifiants incorrects. Merci de réessayer.";
                setFeedbackState("error", message);
                applyFieldErrors(data?.errors);
            } catch (error) {
                console.error("Login error:", error);
                setFeedbackState(
                    "error",
                    "Une erreur réseau est survenue. Merci de réessayer."
                );
            } finally {
                if (!isSuccess) {
                    form.dataset.submitting = "false";
                    submitButton?.removeAttribute("disabled");
                }
            }
        });
    });
</script>
{% endblock %}

