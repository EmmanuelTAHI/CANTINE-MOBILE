{% load static %}
{% load django_browser_reload %}
{% django_browser_reload_script %}

<!DOCTYPE html>
<html lang="fr" class="bg-[#f4f4f5]">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Gestion Cantine HEG{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" referrerpolicy="no-referrer" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        heg: {
                            violet: '#902c8e',
                            violetDark: '#7a2577',
                            gris: '#58595b',
                            grisClair: '#f4f4f5',
                        },
                    },
                    fontFamily: {
                        sans: ['Poppins', 'Inter', 'ui-sans-serif', 'system-ui'],
                        heading: ['Poppins', 'Inter', 'ui-sans-serif', 'system-ui'],
                    },
                    container: {
                        center: true,
                        padding: '1.5rem',
                    },
                }
            },
            darkMode: 'class',
        };
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" />
    <style>
        body {
            font-family: 'Poppins', 'Inter', system-ui, sans-serif;
        }
        
        /* Styles pour le sous-menu des rapports */
        .submenu-container {
            position: relative;
        }
        
        .submenu {
            border: 1px solid rgba(0, 0, 0, 0.1);
            transform: translateX(-5px);
        }
        
        .submenu.show {
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            transform: translateX(0);
        }
        
        .submenu li {
            list-style: none;
        }
        
        /* Amélioration du hover sur les items du menu principal */
        .submenu-trigger:hover {
            background-color: rgba(144, 44, 142, 0.1);
            color: #902c8e;
        }
        
        /* Animation fluide */
        .submenu {
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        
        /* Amélioration responsive */
        @media (max-width: 768px) {
            .submenu {
                position: fixed !important;
                left: 50% !important;
                right: auto !important;
                transform: translateX(-50%) translateY(10px) !important;
                margin: 0 !important;
                max-width: calc(100vw - 2rem);
            }
            
            .submenu.show {
                transform: translateX(-50%) translateY(0) !important;
            }
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="min-h-screen bg-heg-grisClair text-heg-gris antialiased">
    <div class="flex min-h-screen flex-col">
        <header class="bg-white shadow-sm">
            <div class="container flex flex-wrap items-center justify-between gap-4 py-4">
                <div class="flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-full bg-heg-violet text-lg font-semibold text-white shadow-inner">
                        HEG
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.3em] text-heg-gris/70">Espace cantine</p>
                        <h1 class="text-2xl font-semibold text-heg-violet">Gestion Cantine HEG</h1>
                    </div>
                </div>
                {% if user.is_authenticated %}
                {% with role=user.profile.role|default_if_none:"" %}
                <div class="flex flex-col gap-4 md:flex-row md:items-center md:gap-6"> 
                    <nav class="flex flex-wrap items-center gap-2 text-sm font-medium md:gap-3">
                        <a href="{% url 'cantine:dashboard_redirect' %}" class="btn btn-sm btn-ghost border border-transparent text-heg-gris hover:border-heg-violet hover:text-heg-violet">
                            <i class="fas fa-home mr-2"></i>Accueil
                        </a>
                        <a href="{% url 'cantine:eleve_list' %}" class="btn btn-sm btn-ghost border border-transparent text-heg-gris hover:border-heg-violet hover:text-heg-violet">
                            <i class="fas fa-user-graduate mr-2"></i>Élèves
                        </a>
                        <a href="{% url 'cantine:menu_calendar' %}" class="btn btn-sm btn-ghost border border-transparent text-heg-gris hover:border-heg-violet hover:text-heg-violet">
                            <i class="fas fa-calendar-alt mr-2"></i>Calendrier
                        </a>
                        {% if role == 'admin' %}
                        <a href="{% url 'cantine:classe_list' %}" class="btn btn-sm btn-ghost border border-transparent text-heg-gris hover:border-heg-violet hover:text-heg-violet">
                            <i class="fas fa-chalkboard-teacher mr-2"></i>Classes
                        </a>
                        <div class="dropdown dropdown-end">
                            <label tabindex="0" class="btn btn-sm btn-ghost border border-transparent text-heg-gris hover:border-heg-violet hover:text-heg-violet">
                                <i class="fas fa-plus-circle mr-2"></i>Plus
                            </label>
                            <ul tabindex="0" class="menu dropdown-content rounded-box bg-white p-2 shadow min-w-[200px]">
                                <li><a href="{% url 'cantine:prestataire_list' %}" class="flex items-center gap-2"><i class="fas fa-user-tie"></i>Prestataires</a></li>
                                <li><a href="{% url 'cantine:menu_list' %}" class="flex items-center gap-2"><i class="fas fa-utensils"></i>Menu</a></li>
                                <li class="submenu-container relative">
                                    <a class="flex items-center justify-between gap-2 submenu-trigger" onmouseenter="showSubmenu(this)">
                                        <span class="flex items-center gap-2">
                                            <i class="fas fa-chart-pie"></i>Rapports
                                        </span>
                                        <i class="fas fa-chevron-right text-xs"></i>
                                    </a>
                                    <ul class="submenu absolute left-full top-0 ml-1 bg-white rounded-lg shadow-xl p-2 min-w-[220px] opacity-0 invisible pointer-events-none transition-all duration-200 z-50 border border-gray-200">
                                        <li><a href="{% url 'cantine:decompte_journalier' %}" class="flex items-center gap-2 hover:bg-heg-violet/10 hover:text-heg-violet rounded-md px-3 py-2"><i class="fas fa-calendar-day text-sm"></i>Décompte journalier</a></li>
                                        <li><a href="{% url 'cantine:decompte_mensuel' %}" class="flex items-center gap-2 hover:bg-heg-violet/10 hover:text-heg-violet rounded-md px-3 py-2"><i class="fas fa-calendar text-sm"></i>Décompte mensuel</a></li>
                                        <li><a href="{% url 'cantine:detail_plats_servis' %}" class="flex items-center gap-2 hover:bg-heg-violet/10 hover:text-heg-violet rounded-md px-3 py-2"><i class="fas fa-list text-sm"></i>Détails plats servis</a></li>
                                        <li><a href="{% url 'cantine:eleves_inscrits' %}" class="flex items-center gap-2 hover:bg-heg-violet/10 hover:text-heg-violet rounded-md px-3 py-2"><i class="fas fa-address-book text-sm"></i>Élèves inscrits</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                        {% if role == 'prestataire' %}
                        <a href="{% url 'cantine:menu_list' %}" class="btn btn-sm btn-ghost border border-transparent text-heg-gris hover:border-heg-violet hover:text-heg-violet">
                            <i class="fas fa-utensils"></i>Menu
                        </a>
                        {% endif %}
                    </nav>
                    <div class="flex flex-wrap items-center gap-2">
                        <a href="{% url 'cantine:profile' %}" class="btn btn-sm border-none bg-heg-violet text-white hover:bg-heg-violetDark">
                            <i class="fas fa-user-circle mr-2"></i>Mon profil
                        </a>
                        <form action="{% url 'cantine:logout' %}" method="post" class="m-0">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-ghost border border-heg-gris/30 text-heg-gris hover:border-heg-violet hover:text-heg-violet">
                                <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
                            </button>
                        </form>
                    </div>
                </div>
                {% endwith %}
                {% else %}
                <nav>
                    <a href="{% url 'cantine:login' %}" class="btn btn-sm bg-heg-violet text-white hover:bg-heg-violetDark">Connexion</a>
                </nav>
                {% endif %}
            </div>
        </header>

        <main class="flex-1">
            {% include "cantines/partials/messages.html" %}
            {% block content %}{% endblock %}
        </main>

        <footer class="bg-white py-6 shadow-inner">
            <div class="container flex flex-col justify-between gap-3 text-sm text-heg-gris/70 md:flex-row">
                <p>&copy; {% now "Y" %} HEG · Service de restauration scolaire.</p>
                <div class="flex gap-4">
                    <a href="#" class="hover:text-heg-violet">Mentions légales</a>
                    <a href="#" class="hover:text-heg-violet">Confidentialité</a>
                    <a href="#" class="hover:text-heg-violet">Support</a>
                </div>
            </div>
        </footer>
    </div>

    {% block extra_scripts %}{% endblock %}
    
    <script>
        // Fonction pour afficher le sous-menu des rapports
        function showSubmenu(element) {
            const submenu = element.nextElementSibling;
            if (submenu && submenu.classList.contains('submenu')) {
                // Rendre temporairement visible pour calculer la position
                submenu.style.visibility = 'hidden';
                submenu.style.opacity = '0';
                submenu.style.display = 'block';
                
                // Vérifier si le sous-menu sort de l'écran à droite
                const containerRect = element.closest('.submenu-container').getBoundingClientRect();
                const submenuWidth = submenu.offsetWidth || 220;
                const viewportWidth = window.innerWidth;
                const spaceOnRight = viewportWidth - containerRect.right;
                
                // Si pas assez d'espace à droite, afficher à gauche
                if (spaceOnRight < submenuWidth + 20) {
                    submenu.classList.remove('left-full', 'ml-1');
                    submenu.classList.add('right-full', 'mr-1');
                } else {
                    submenu.classList.remove('right-full', 'mr-1');
                    submenu.classList.add('left-full', 'ml-1');
                }
                
                // Réinitialiser et afficher
                submenu.style.visibility = '';
                submenu.style.display = '';
                submenu.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                submenu.classList.add('opacity-100', 'visible', 'pointer-events-auto', 'show');
                submenu.style.transform = 'translateX(0)';
            }
        }
        
        // Fonction pour masquer le sous-menu des rapports
        function hideSubmenu(element) {
            const submenu = element.nextElementSibling;
            if (submenu && submenu.classList.contains('submenu')) {
                // Délai pour permettre le survol du sous-menu
                setTimeout(() => {
                    if (!submenu.matches(':hover') && !element.matches(':hover')) {
                        submenu.classList.remove('opacity-100', 'visible', 'pointer-events-auto', 'show');
                        submenu.classList.add('opacity-0', 'invisible', 'pointer-events-none');
                        submenu.style.transform = 'translateX(-5px)';
                    }
                }, 150);
            }
        }
        
        // Gérer le survol du sous-menu lui-même
        document.addEventListener('DOMContentLoaded', function() {
            const submenus = document.querySelectorAll('.submenu');
            submenus.forEach(submenu => {
                submenu.addEventListener('mouseenter', function() {
                    this.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                    this.classList.add('opacity-100', 'visible', 'pointer-events-auto', 'show');
                    this.style.transform = 'translateX(0)';
                });
                
                submenu.addEventListener('mouseleave', function() {
                    this.classList.remove('opacity-100', 'visible', 'pointer-events-auto', 'show');
                    this.classList.add('opacity-0', 'invisible', 'pointer-events-none');
                    this.style.transform = 'translateX(-5px)';
                });
            });
            
            // Fermer le sous-menu si on clique ailleurs
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.submenu-container')) {
                    submenus.forEach(submenu => {
                        submenu.classList.remove('opacity-100', 'visible', 'pointer-events-auto', 'show');
                        submenu.classList.add('opacity-0', 'invisible', 'pointer-events-none');
                        submenu.style.transform = 'translateX(-5px)';
                    });
                }
            });
        });
    </script>
</body>
</html>

